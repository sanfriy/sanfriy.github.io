<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>随机一言</title>
    <script>
        async function fetchUrls() {
            const response = await fetch('urls.json');
            const data = await response.json();
            return data.urls;
        }

        async function openUrlsSequentially(urls) {
            for (let i = 0; i < urls.length; i++) {
                const iframe = document.createElement('iframe');
                iframe.src = urls[i];
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                await new Promise(resolve => {
                    const randomDelay = Math.floor(Math.random() * 9000) + 9000; // 9-18 秒
                    setTimeout(() => {
                        resolve();
                    }, randomDelay);
                });
            }
        }

        async function initializeUrls() {
            if (!localStorage.getItem('tasksCompleted')) {
                const urls = await fetchUrls();
                await openUrlsSequentially(urls);
                localStorage.setItem('tasksCompleted', 'true');
                document.getElementById('countdown-timer').textContent = '正在完成今日任务';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeUrls);
    </script>
</head>
<body>
<main>
    <div class="search-info">
        <div>当前设备：<span id="device-type">检测中...</span></div>
        <div>当前搜索词：<span id="current-search-word">等待倒计时结束...</span></div>
        <div>启动自动搜索中：<span id="countdown-timer">加载中...</span></div>
        <div>本轮已完成搜索：<span id="completed-searches">0</span> 次</div>
        <div>总计已完成搜索：<span id="total-searches">0</span> 次</div>
    </div>
    <div class="button-container">
        <button id="start-button" title="点击开始自动搜索">开始搜索</button>
        <button id="stop-button" title="点击停止自动搜索">停止搜索</button>
        <button id="exception-button" title="点击切换到异常模式">异常模式</button>
        <button id="deleteDataButton" title="点击清空计数数据">清空计数</button>
    </div>
    <h2>搜索历史</h2>
    <div id="search-history"></div>
</main>
<script>
    const defaultSearchWords = ["盛年不重来，一日难再晨"];
    let countdownIntervalId;
    let countdownTimeoutId;
    let nextSearchWord = '';
    let searchToggle = true; // 用于切换不同的搜索 URL
    let apiIndex = 0; // 用于循环使用 API
    let isSearching = false; // 标记搜索是否正在进行中
    let completedSearches = 0; // 记录已完成的搜索次数
    let totalSearches = localStorage.getItem('totalSearches') ? parseInt(localStorage.getItem('totalSearches')) : 0; // 初始化总搜索次数
    let isException = localStorage.getItem('isException') === 'true'; // 初始化异常状态
    let maxStops;
    let countdownMin = 60; // 默认最小倒计时
    let countdownMax = 120; // 默认最大倒计时

    const apis = [
        'https://v1.hitokoto.cn/',
        'https://api.xygeng.cn/one',
        'https://api.xygeng.cn/openapi/one'
    ];

    // 页面加载时显示已完成的总搜索次数
    document.getElementById('total-searches').textContent = totalSearches;

    // 判断设备类型
    function detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        const isMobile = /iphone|ipad|ipod|android/.test(userAgent);
        const deviceTypeElement = document.getElementById('device-type');
        if (isMobile) {
            deviceTypeElement.textContent = '移动设备';
            localStorage.setItem('maxStops', '24');
        } else {
            deviceTypeElement.textContent = '电脑设备';
            localStorage.setItem('maxStops', '36');
        }
    }

    async function fetchSearchWords() {
        const apiUrl = apis[apiIndex];
        apiIndex = (apiIndex + 1) % apis.length; // 循环切换 API
        try {
            let response = await fetch(apiUrl);
            let data = await response.json();
            if (data.hitokoto) {
                return data.hitokoto;
            } else if (data.data && data.data.content) {
                return data.data.content;
            } else {
                throw new Error('从 API 获取的数据无效');
            }
        } catch {
            return defaultSearchWords[Math.floor(Math.random() * defaultSearchWords.length)];
        }
    }

    function displaySearchWord(word) {
        document.getElementById('current-search-word').textContent = word;
    }

    function addSearchHistory(word, iframeUrl) {
        const searchHistoryElement = document.getElementById('search-history');
        const historyItems = searchHistoryElement.querySelectorAll('.search-history-item');
        if (historyItems.length >= 2) {
            // 如果历史条目数量超过两个，删除最旧的 iframe
            const iframes = historyItems[1].querySelectorAll('iframe');
            if (iframes.length > 0) {
                historyItems[1].removeChild(iframes[0]);
            }
        }
        const newHistoryItem = document.createElement('div');
        newHistoryItem.className = 'search-history-item';
        newHistoryItem.innerHTML = `<p>${word}</p><iframe src="${iframeUrl}"></iframe>`;
        searchHistoryElement.insertBefore(newHistoryItem, searchHistoryElement.firstChild);
    }

    function performSearch(word) {
        const randomString = generateRandomString(4);
        const randomCvid = generateRandomString(32);
        let searchUrl;

        if (searchToggle) {
            searchUrl = `https://www.cn.bing.com/search?q=${encodeURIComponent(word)}&form=${randomString}&cvid=${randomCvid}`;
        } else {
            searchUrl = `https://www.cn.bing.com/search?q=${encodeURIComponent(word)}&cvid=${randomCvid}&FORM=${randomString}`;
        }

        searchToggle = !searchToggle; // 切换 URL 格式以备下一次搜索
        addSearchHistory(word, searchUrl);
    }

    function generateRandomString(length) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }

    async function startAutoSearch() {
        if (isSearching) return; // 如果已经在搜索中，直接返回

        isSearching = true; // 标记搜索正在进行中

        async function startCountdown() {
            const delay = Math.floor(Math.random() * 9000) + 9000; // 9-18 秒的随机延迟
            let countdown = Math.ceil(delay / 1000);
            const countdownElement = document.getElementById('countdown-timer');

            nextSearchWord = await fetchSearchWords();
            displaySearchWord(nextSearchWord);
            countdownElement.textContent = countdown;

            countdownIntervalId = setInterval(() => {
                countdown -= 1;
                countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(countdownIntervalId);
                }
            }, 1000);

            countdownTimeoutId = setTimeout(() => {
                performSearch(nextSearchWord);
                clearInterval(countdownIntervalId);
                completedSearches++;
                totalSearches++;

                // 更新已完成搜索次数和总搜索次数的显示
                document.getElementById('completed-searches').textContent = completedSearches;
                document.getElementById('total-searches').textContent = totalSearches;

                // 保存总搜索次数到 localStorage
                localStorage.setItem('totalSearches', totalSearches.toString());
                // 检查是否已经达到总搜索次数的要求
                if (totalSearches >= localStorage.getItem('maxStops')) {
                    stopAutoSearch();
                    localStorage.removeItem('totalSearches');
                    setTimeout(function(){
                                          window.location.href = 'http://www.bing.com';
                                         }, 6000); 
                    } else {
                            if (completedSearches % 4 === 0) {// 检查是否完成了4次搜索
                                // 在完成每4次搜索后设置延迟，然后刷新页面
                                setTimeout(() => {
                                    window.location.reload();
                                }, 8000); // 设置适当的延迟时间，这里示例为 8000 毫秒（8秒）
                            } else {
                                    startCountdown(); // 继续搜索 
                                }
                }
            }, delay);
        }

        startCountdown(); // 开始第一次搜索倒计时
    }

    function stopAutoSearch() {
        clearInterval(initialCountdownInterval);
        clearInterval(countdownIntervalId);
        clearTimeout(countdownTimeoutId);
        document.getElementById('countdown-timer').textContent = '已停止';
        isSearching = false; // 标记搜索已停止

        // 清除页面加载时的初始化倒计时
        if (countdownWorker) {
            countdownWorker.postMessage({ type: 'stop' });
        }
    }

    // 页面加载完成后开始初始化
    document.addEventListener('DOMContentLoaded', () => {
        initializeCountdown(); // 初始化倒计时
        detectDevice(); // 检测设备类型
    });

    // 添加一个全局变量来存储初始倒计时的计时器 ID
    let initialCountdownInterval;

    function initializeCountdown() {
        const countdownElement = document.getElementById('countdown-timer');
        let initialCountdown = Math.floor(Math.random() * (countdownMax - countdownMin + 1)) + countdownMin; // 初始化倒计时为900-960秒
        countdownElement.textContent = initialCountdown;

        countdownWorker = new Worker(URL.createObjectURL(new Blob([`
            let intervalId;
            let remainingTime;

            self.onmessage = function(e) {
                const { type, duration } = e.data;

                if (type === 'start') {
                    remainingTime = duration;
                    intervalId = setInterval(() => {
                        remainingTime -= 1;
                        self.postMessage({ remainingTime });
                        if (remainingTime <= 0) {
                            clearInterval(intervalId);
                            self.postMessage({ type: 'done' });
                        }
                    }, 1000);
                } else if (type === 'stop') {
                    clearInterval(intervalId);
                }
            };
        `], { type: 'application/javascript' })));

        countdownWorker.postMessage({ type: 'start', duration: initialCountdown });

        countdownWorker.onmessage = function(e) {
            const { remainingTime, type } = e.data;

            if (type === 'done') {
                startAutoSearch(); // 倒计时结束后开始自动搜索
            } else {
                countdownElement.textContent = remainingTime;
            }
        };
    }

    document.getElementById("deleteDataButton").addEventListener("click", function() {
        localStorage.removeItem("totalSearches");
        localStorage.removeItem("isException");
        localStorage.removeItem("tasksCompleted");
        document.getElementById('total-searches').textContent = '0';
        document.getElementById('completed-searches').textContent = '0';
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    });

    document.getElementById('start-button').addEventListener('click', startAutoSearch);
    document.getElementById('stop-button').addEventListener('click', stopAutoSearch);

    // 异常按钮逻辑
    document.getElementById('exception-button').addEventListener('click', function() {
        if (!isException) {
            isException = true;
            localStorage.setItem('isException', 'true');
            this.textContent = '恢复正常';
            this.title = '点击切换到正常模式';
            countdownMin = 900;
            countdownMax = 960;
        } else {
            isException = false;
            localStorage.setItem('isException', 'false');
            this.textContent = '异常模式';
            this.title = '点击切换到异常模式'; 
            countdownMin = 60;
            countdownMax = 120;
        }
        setTimeout(() => {
            window.location.reload();
        }, 1000); // 1秒后刷新页面
    });

    // 初始化异常按钮状态
    if (isException) {
        const exceptionButton = document.getElementById('exception-button');
        exceptionButton.textContent = '恢复正常';
        exceptionButton.title = '点击切换到正常模式'; // 初始化提示文本
        countdownMin = 900;
        countdownMax = 960;
    }
</script>
</body>
</html>
